# 단계별 상세 기획서

## 1단계: 결제 플로우 MVP
**목표** 
후원자가 금액 입력 → 결제 생성 → 웹훅 확정 → 내 결제 내역 조회 
(소득 증명 및 검수 절차는 생략)

**주요 기능**

- 케이스 등록/조회 (사연 등록 시 자동 공개: `FUNDING`, 지급 예정일 임박한 케이스 조회)
- 결제 생성 API (`/payments`)
- PG사 샌드박스 연동 (승인/실패 응답)
- Webhook 처리 & 결제 상태 확정
- 후원자 마이페이지: 내 결제 내역 조회
- 환불은 스텁 수준 구현 (`/payments/{id}/refund` 기본 동작만)

---

## 2단계: 소득 증명 & 가상 지급
**목표** 
소득 증명 검수 후 케이스 공개, 병원비 영수증 검수 후 가상 지급 처리

**주요 기능**
- 수혜자 소득 증명 업로드 API
- 관리자 소득 증명 승인/반려
- 승인된 케이스만 피드 공개 (`UNDER_REVIEW → FUNDING`)
- 영수증 업로드(수혜자)
- 관리자 영수증 검수 승인/반려
- 가상 지급 실행 API (`/payouts`)
- 후원자 타임라인 뷰: 결제 → 소득 증명 승인 → 영수증 승인 → 가상 지급

---

## 3단계: 환불 & 예외 처리
**목표** 
후원자가 안심할 수 있는 환불 절차 및 예외 상황 처리

**주요 기능**
- 후원자 환불 요청 API
- 관리자 환불 승인/거절
- 결제/정산 상태 전이 로직 강화
- 감사 로그 기록
- 소득 증명 위조/허위 발견 시 환불 프로세스 연동

---

## 4단계: 투명 공개 & 증빙 요청
**목표**
후원자에게 투명성을 제공하되 개인정보를 보호하는 증빙 요청 기능 강화

**주요 기능**
- 후원자 타임라인 고도화  
  - 내 결제가 어떤 사연에 사용되었는지 표시  
  - 지급 내역마다 “증빙 요청” 버튼 제공
- 후원자 증빙 요청 API
  - `POST /donors/payouts/{id}/proof-request` (요청 생성)  
  - 요청 상태 조회 가능 (대기/승인/거절)
- 관리자 승인 플로우  
  - 원본 증빙(영수증/병원 지급 확인서) 검토  
  - 개인정보(환자명, 주민번호, 진료내역 등) 마스킹 처리  
  - 승인 시 마스킹 버전 파일 업로드
- 후원자 열람  
  - 요청 승인 후 “증빙 다운로드” 버튼 활성화  
  - 다운로드 가능한 자료는 마스킹 처리된 PDF/이미지
- 관리자 대시보드  
  - 증빙 요청 처리 현황(대기/승인/거절)  
  - 전체 후원액, 지급액, 잔액, 소득 검증 승인율, 환불 통계, 웹훅 성공률 등 KPI 차트 시각화

**데이터 모델 보강**
- `payout_proofs` 테이블에 `is_masked` 컬럼 추가 (후원자 제공용 구분)  
- `payout_proof_requests` 테이블 신설: 후원자 요청/승인/거절 이력 관리

---

## 정리
- 1단계: **결제 중심** (소득 증명/검수 제외)  
- 2단계: **소득 증명 + 영수증 검수 + 가상 지급**  
- 3단계: **환불 + 예외 처리 강화**  
- 4단계: **투명 공개 + 증빙 요청 기능 (마스킹 자료 제공)**
